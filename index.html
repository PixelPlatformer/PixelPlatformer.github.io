<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Platformer: Chaos Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tiny5&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #111; color: #fff; font-family: 'Tiny5', sans-serif; overflow: hidden; }
        canvas { display: block; margin: 0 auto; background: #222; border: 2px solid #555; }
        
        /* --- LOADING SCREEN CSS (ADDED) --- */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            z-index: 9999; /* Sits on top of everything */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        /* The Spinner Container */
        .loader-box {
            position: relative;
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
        }

        /* The Invisible Rotating Spans */
        .loader-box span {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(calc(30deg * var(--i)));
        }

        /* The Visible Squares */
        .loader-box span::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 15px;
            height: 15px;
            background: #00d2ff; /* Cyan Color */
            box-shadow: 0 0 10px #00d2ff, 0 0 20px #00d2ff; /* Glow Effect */
            opacity: 0;
            animation: fadeSquare 1s linear infinite;
            animation-delay: calc(1s / 12 * var(--i));
        }

        @keyframes fadeSquare {
            0% { opacity: 1; transform: scale(1.2); }
            80%, 100% { opacity: 0; transform: scale(1); }
        }

        /* Class to hide the loader */
        .loader-hidden {
            opacity: 0;
            pointer-events: none;
        }
        /* --- END LOADING SCREEN CSS --- */


        /* UI OVERLAY */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        #rng-box {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); border: 4px solid #fff; padding: 10px;
            text-align: center; pointer-events: auto; cursor: pointer;
        }
        #rng-box:active { transform: translateX(-50%) scale(0.95); }
        
        #item-display { font-size: 30px; color: #ffff00; text-shadow: 0 0 10px #ffff00; }
        #rng-label { font-size: 14px; color: #aaa; }

        /* MENU STYLES */
        .menu-screen { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); padding: 40px; border: 2px solid white; text-align: center;
            display: none; z-index: 100;
        }
        /* Show Main Menu by default, but hidden behind loader initially */
        #main-menu { display: block; }
        
        .btn { 
            background: #333; color: white; border: 2px solid white; 
            padding: 10px 20px; font-family: 'Tiny5'; font-size: 20px; cursor: pointer; margin: 10px;
        }
        .btn:hover { background: #fff; color: #000; }
        input { font-family: 'Tiny5'; font-size: 20px; padding: 5px; text-align: center; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-box">
            <span style="--i:1;"></span>
            <span style="--i:2;"></span>
            <span style="--i:3;"></span>
            <span style="--i:4;"></span>
            <span style="--i:5;"></span>
            <span style="--i:6;"></span>
            <span style="--i:7;"></span>
            <span style="--i:8;"></span>
            <span style="--i:9;"></span>
            <span style="--i:10;"></span>
            <span style="--i:11;"></span>
            <span style="--i:12;"></span>
        </div>
        <p style="font-size: 20px; letter-spacing: 2px;">LOADING CHAOS...</p>
    </div>
    <div id="main-menu" class="menu-screen">
        <h1 style="font-size: 60px; margin-bottom: 10px;">PIXEL PLATFORMER</h1>
        <p style="color: #ffff00;">CHAOS UPDATE</p>
        <button class="btn" onclick="startSingle()">Single Player</button>
        <button class="btn" onclick="showMenu('multi-menu')">Multiplayer</button>
    </div>

    <div id="multi-menu" class="menu-screen">
        <h2>MULTIPLAYER</h2>
        <button class="btn" onclick="setupHost()">Host Game</button>
        <button class="btn" onclick="showMenu('join-menu')">Join Game</button>
        <br><button class="btn" onclick="showMenu('main-menu')" style="border-color: red;">Back</button>
    </div>

    <div id="host-menu" class="menu-screen">
        <h2>LOBBY CREATED</h2>
        <p>Your Code: <span id="host-code" style="color: #00ffcc; font-size: 30px;">...</span></p>
        <p>Waiting for player...</p>
    </div>

    <div id="join-menu" class="menu-screen">
        <h2>JOIN GAME</h2>
        <input type="text" id="join-code" placeholder="ENTER CODE" maxlength="4">
        <button class="btn" onclick="joinGame()">Connect</button>
        <br><button class="btn" onclick="showMenu('multi-menu')" style="border-color: red;">Back</button>
    </div>

    <div id="ui-layer">
        <div id="rng-box" onclick="spinRNG()">
            <div id="rng-label">PRESS 'E' OR CLICK</div>
            <div id="item-display">???</div>
        </div>
        <div style="position: absolute; top: 20px; left: 20px; font-size: 20px;">
            POWER: <span id="power-display">NONE</span>
        </div>
    </div>

    <canvas id="gameCanvas" width="1000" height="600"></canvas>

<script>
    // --- LOADING SCREEN LOGIC (ADDED) ---
    window.addEventListener('load', function() {
        // Wait 2 seconds so people can see the animation, then fade out
        setTimeout(function() {
            const loader = document.getElementById('loading-screen');
            loader.classList.add('loader-hidden');
            
            // Remove it from the DOM completely after the fade
            loader.addEventListener('transitionend', function() {
                if(loader.parentNode) {
                    loader.parentNode.removeChild(loader);
                }
            });
        }, 2000); // 2000ms = 2 seconds
    });

    // --- CONFIGURATION ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Game State
    let myId = null;
    let peer = null;
    let conn = null;
    let isGameRunning = false;
    let isHost = false;

    // Player Objects
    const ME = { 
        x: 100, y: 300, w: 40, h: 40, 
        vx: 0, vy: 0, 
        color: 'white', power: 'none', item: 'Fists',
        rolling: false, facingRight: true 
    };
    
    const OTHER = { 
        x: 800, y: 300, w: 40, h: 40, 
        color: 'gray', power: 'none', item: 'Fists',
        rolling: false 
    };

    // Powers Configuration
    const POWERS = {
        'LUCKY': { color: '#FFD700', desc: 'Better RNG Items' },
        'FAST': { color: '#FF8C00', desc: '1.5x Speed' },
        'STRONG': { color: '#DC143C', desc: 'High Knockback' },
        'SMALL': { color: '#FF69B4', desc: 'Tiny Hitbox' },
        'INVISIBLE': { color: 'rgba(255, 255, 255, 0.2)', desc: 'Ghost Mode' },
        'TIME FREEZE': { color: '#00BFFF', desc: 'Freezes Enemies' }
    };

    // Items Configuration
    const ITEMS = ['Rock', 'Stick', 'Snowball', 'Sword'];
    
    // Physics Constants
    const GRAVITY = 0.8;
    const JUMP_FORCE = -15;
    const SPEED = 5;
    const GROUND = 500;

    // Input Tracking
    const keys = {};

    // --- SETUP & MENUS ---
    function showMenu(id) {
        document.querySelectorAll('.menu-screen').forEach(el => el.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    function generateId() {
        return Math.random().toString(36).substr(2, 4).toUpperCase();
    }

    function assignRandomPower() {
        const keys = Object.keys(POWERS);
        const randomKey = keys[Math.floor(Math.random() * keys.length)];
        ME.power = randomKey;
        ME.color = POWERS[randomKey].color;
        
        // Apply Passive Effects immediately
        if (ME.power === 'SMALL') { ME.w = 20; ME.h = 20; }
        
        document.getElementById('power-display').innerText = randomKey;
        document.getElementById('power-display').style.color = ME.color;
    }

    // --- MULTIPLAYER LOGIC ---
    function setupHost() {
        showMenu('host-menu');
        myId = generateId();
        document.getElementById('host-code').innerText = myId;
        
        peer = new Peer(myId);
        peer.on('connection', (c) => {
            conn = c;
            startGame();
        });
        isHost = true;
    }

    function joinGame() {
        const code = document.getElementById('join-code').value.toUpperCase();
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(code);
            conn.on('open', () => {
                startGame();
            });
        });
        isHost = false;
    }

    function startSingle() {
        startGame();
    }

    // --- GAME ENGINE ---
    function startGame() {
        document.querySelectorAll('.menu-screen').forEach(el => el.style.display = 'none');
        document.getElementById('ui-layer').style.display = 'block';
        
        assignRandomPower();
        
        // Initial positions
        ME.x = isHost ? 100 : 800;
        ME.y = 300;
        
        isGameRunning = true;
        gameLoop();
        
        // Send data every 20ms (50 times a second)
        setInterval(sendData, 20);
    }

    // --- INPUT HANDLING ---
    window.addEventListener('keydown', e => {
        keys[e.key.toLowerCase()] = true;
        if (e.key === ' ') triggerRoll();
        if (e.key === 'e') spinRNG();
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    function triggerRoll() {
        if (!ME.rolling) {
            ME.rolling = true;
            ME.vx = ME.facingRight ? 15 : -15; // Dash boost
            setTimeout(() => ME.rolling = false, 300); // 0.3s roll duration
        }
    }

    function spinRNG() {
        // Animation effect
        const display = document.getElementById('item-display');
        let iterations = 0;
        const maxIterations = 10;
        
        const interval = setInterval(() => {
            display.innerText = ITEMS[Math.floor(Math.random() * ITEMS.length)];
            iterations++;
            if (iterations > maxIterations) {
                clearInterval(interval);
                finalizeItem();
            }
        }, 50);
    }

    function finalizeItem() {
        let chance = Math.random();
        
        // Lucky Power Buff
        if (ME.power === 'LUCKY') chance += 0.3; 

        let newItem = 'Rock';
        if (chance > 0.4) newItem = 'Stick';
        if (chance > 0.7) newItem = 'Snowball';
        if (chance > 0.9) newItem = 'Sword'; // Rare

        ME.item = newItem;
        document.getElementById('item-display').innerText = newItem;
    }

    // --- NETWORK SYNC ---
    function sendData() {
        if (conn && conn.open) {
            conn.send({
                x: ME.x, y: ME.y,
                color: ME.color,
                w: ME.w, h: ME.h,
                item: ME.item
            });
        }
    }

    // Hacky fix to ensure data listener works
    setInterval(() => {
        if(conn) {
            conn.on('data', (data) => {
                OTHER.x = data.x;
                OTHER.y = data.y;
                OTHER.color = data.color;
                OTHER.w = data.w;
                OTHER.h = data.h;
                OTHER.item = data.item;
            });
        }
    }, 1000);


    // --- MAIN LOOP ---
    function update() {
        // Speed Modifiers
        let moveSpeed = SPEED;
        if (ME.power === 'FAST') moveSpeed *= 1.5;
        if (ME.rolling) moveSpeed *= 2; // Fast during roll

        // Horizontal Move
        if (keys['a']) { ME.vx = -moveSpeed; ME.facingRight = false; }
        else if (keys['d']) { ME.vx = moveSpeed; ME.facingRight = true; }
        else { ME.vx *= 0.8; } // Friction

        // Jump
        if (keys['w'] && ME.y + ME.h >= GROUND) {
            ME.vy = JUMP_FORCE;
        }

        // Apply Physics
        ME.vy += GRAVITY;
        ME.x += ME.vx;
        ME.y += ME.vy;

        // Ground Collision
        if (ME.y + ME.h > GROUND) {
            ME.y = GROUND - ME.h;
            ME.vy = 0;
        }
        
        // Wall Collision
        if (ME.x < 0) ME.x = 0;
        if (ME.x > canvas.width - ME.w) ME.x = canvas.width - ME.w;
    }

    function draw() {
        // Clear Screen
        ctx.fillStyle = '#222';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw Floor
        ctx.fillStyle = '#444';
        ctx.fillRect(0, GROUND, canvas.width, 100);

        // Draw Me
        ctx.fillStyle = ME.color;
        // Visual Roll Effect (Squish)
        let h = ME.h; let y = ME.y;
        if (ME.rolling) { h = ME.h / 2; y = ME.y + ME.h / 2; }
        
        ctx.fillRect(ME.x, y, ME.w, h);
        
        // Draw My Item (Simple representation)
        ctx.fillStyle = 'white';
        ctx.font = '10px Arial';
        ctx.fillText(ME.item, ME.x, ME.y - 10);

        // Draw Other Player
        ctx.fillStyle = OTHER.color;
        ctx.fillRect(OTHER.x, OTHER.y, OTHER.w, OTHER.h);
    }

    function gameLoop() {
        if (!isGameRunning) return;
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

</script>
</body>
</html>
