<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Platformer: Whiteout Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tiny5&display=swap" rel="stylesheet">
    
    <style>
        /* --- GLOBAL & RESET --- */
        body { 
            margin: 0; 
            background: #000; 
            color: #fff; 
            font-family: 'Tiny5', sans-serif; 
            overflow: hidden; 
        }
        canvas { display: block; margin: 0 auto; background: #111; border: 2px solid #fff; }
        
        /* --- WHITE NEON THEME --- */
        .neon-text {
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #aaa, 0 0 20px #fff;
        }
        
        /* SCOREBOARD */
        #scoreboard {
            position: absolute; top: 10px; right: 20px;
            text-align: right; pointer-events: none;
        }
        .score-entry { font-size: 24px; color: #fff; margin-bottom: 5px; }

        /* LOADING SCREEN */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .loader-box { position: relative; width: 100px; height: 100px; margin-bottom: 20px; }
        .loader-box span {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform: rotate(calc(30deg * var(--i)));
        }
        .loader-box span::before {
            content: ''; position: absolute; top: 0; left: 0; width: 15px; height: 15px;
            background: #fff; box-shadow: 0 0 10px #fff, 0 0 20px #fff;
            opacity: 0; animation: fadeSquare 1s linear infinite;
            animation-delay: calc(1s / 12 * var(--i));
        }
        @keyframes fadeSquare {
            0% { opacity: 1; transform: scale(1.2); } 80%, 100% { opacity: 0; transform: scale(1); }
        }
        .loader-hidden { opacity: 0; pointer-events: none; }

        /* MENUS */
        .menu-screen { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #000; padding: 40px; 
            border: 4px solid #fff; box-shadow: 0 0 15px #fff;
            text-align: center; display: none; z-index: 100; min-width: 300px;
        }
        #main-menu { display: block; }
        
        .btn { 
            background: #000; color: #fff; border: 2px solid #fff; 
            padding: 10px 20px; font-family: 'Tiny5'; font-size: 20px; cursor: pointer; margin: 10px;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }
        input { 
            background: #000; color: #fff; border: 2px solid #fff;
            font-family: 'Tiny5'; font-size: 20px; padding: 10px; text-align: center; outline: none;
        }

        /* UI OVERLAY */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        #rng-box {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #000; border: 3px solid #fff; padding: 15px; width: 150px;
            text-align: center; pointer-events: auto; cursor: pointer;
            box-shadow: 0 0 10px #fff;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader-box">
            <span style="--i:1;"></span><span style="--i:2;"></span><span style="--i:3;"></span>
            <span style="--i:4;"></span><span style="--i:5;"></span><span style="--i:6;"></span>
            <span style="--i:7;"></span><span style="--i:8;"></span><span style="--i:9;"></span>
            <span style="--i:10;"></span><span style="--i:11;"></span><span style="--i:12;"></span>
        </div>
        <p class="neon-text" style="font-size: 20px; letter-spacing: 2px;">LOADING RESOURCES...</p>
    </div>

    <div id="main-menu" class="menu-screen">
        <h1 class="neon-text" style="font-size: 50px; margin: 0;">WHITEOUT FIGHT</h1>
        <p style="color: #aaa; margin-bottom: 30px;">KNOCKOUT ARENA</p>
        <button class="btn" onclick="startSingle()">Single Player</button>
        <button class="btn" onclick="showMenu('multi-menu')">Multiplayer</button>
    </div>

    <div id="multi-menu" class="menu-screen">
        <h2 class="neon-text">MULTIPLAYER</h2>
        <button class="btn" onclick="setupHost()">Host Game</button>
        <button class="btn" onclick="showMenu('join-menu')">Join Game</button>
        <br><button class="btn" onclick="showMenu('main-menu')" style="border-color: #555; color: #888;">Back</button>
    </div>

    <div id="host-menu" class="menu-screen">
        <h2 class="neon-text">LOBBY</h2>
        <p>CODE: <span id="host-code" style="color: #fff; font-size: 30px; border-bottom: 2px solid #fff;">...</span></p>
        <p>Waiting for players...</p>
    </div>

    <div id="join-menu" class="menu-screen">
        <h2 class="neon-text">JOIN</h2>
        <input type="text" id="join-code" placeholder="ENTER CODE" maxlength="4">
        <button class="btn" onclick="joinGame()">Connect</button>
        <br><button class="btn" onclick="showMenu('multi-menu')" style="border-color: #555;">Back</button>
    </div>

    <div id="ui-layer">
        <div id="scoreboard">
            <div class="score-entry">ME: <span id="score-me">0</span></div>
            <div class="score-entry" style="color: #ff4444;">ENEMY: <span id="score-enemy">0</span></div>
        </div>

        <div id="rng-box" onclick="spinRNG()">
            <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">CLICK FOR ITEM</div>
            <div id="item-display" class="neon-text" style="font-size: 20px;">NOTHING</div>
        </div>
        
        <div style="position: absolute; top: 20px; left: 20px; font-size: 16px;">
            <div id="cooldown-msg" style="color: red; opacity: 0;">ROLL COOLDOWN</div>
        </div>
    </div>

    <canvas id="gameCanvas" width="1000" height="600"></canvas>

<script>
    // --- CUSTOM ASSETS (PUT YOUR IMAGE LINKS HERE) ---
    // Leave src as '' to use the default colors.
    const ASSETS = {
        player: { src: '', color: '#fff' },     // Your Character
        enemy:  { src: '', color: '#ff4444' },  // Enemy Character (Red)
        sword:  { src: '' },
        snowball: { src: '' },
        nuke:   { src: '' },
        laser:  { src: '' }
    };

    // Helper to load images
    const sprites = {};
    for (const key in ASSETS) {
        if (ASSETS[key].src) {
            const img = new Image();
            img.src = ASSETS[key].src;
            sprites[key] = img;
        }
    }

    // --- LOAD HANDLER ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            const l = document.getElementById('loading-screen');
            l.style.opacity = '0';
            setTimeout(() => l.remove(), 500);
        }, 1000);
    });

    // --- PHYSICS CONFIG (Adjusted for "Snappy" feel) ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    const GRAVITY = 0.9;      // Heavy gravity for less float
    const JUMP_FORCE = -18;   // Strong jump
    const SPEED = 5;
    const GROUND = 500;
    const ROLL_COOLDOWN = 1500; // 1.5 seconds

    // --- GAME STATE ---
    let myId = null;
    let peer = null;
    let conn = null;
    let isHost = false;
    let isGameRunning = false;
    let projectiles = []; // For snowballs
    let scores = { me: 0, enemy: 0 };
    let canRoll = true;

    // --- PLAYER OBJECTS ---
    const ME = { 
        x: 100, y: 300, w: 40, h: 40, 
        vx: 0, vy: 0, 
        item: 'Nothing', frozen: false, facingRight: true 
    };
    const OTHER = { 
        x: 800, y: 300, w: 40, h: 40, 
        color: '#ff4444', item: 'Nothing', frozen: false 
    };

    // --- ITEM RARITY LOGIC ---
    function getRandomItem() {
        const r = Math.random() * 1000; // 0 to 1000
        
        // 1. Ultra Rare (Laser) - 1/1000
        if (r <= 1) return 'LASER';
        
        // 2. Legendary (Teleporter) - 1/500 (approx)
        if (r <= 3) return 'TELEPORTER'; // 2, 3
        
        // 3. Epic (Nuke) - 1/100 (approx)
        if (r <= 13) return 'NUKE'; 
        
        // 4. Common Pool (remaining ~987)
        // Re-roll for standard items to keep percentages clean
        const standard = Math.random();
        
        if (standard < 0.50) return 'NOTHING';        // 50%
        if (standard < 0.70) return 'STICK';          // 20%
        if (standard < 0.90) return 'SNOWBALL';       // 20%
        return 'SWORD';                               // 10%
    }

    // --- ITEM USAGE LOGIC ---
    function useItem() {
        if (ME.frozen) return;

        // SWORD
        if (ME.item === 'SWORD') {
            // Simple hitbox check
            if (checkHit(ME, OTHER, 80)) {
                sendHit('KNOCKBACK', 20); // Big physical hit
            }
        }

        // STICK
        if (ME.item === 'STICK') {
            if (checkHit(ME, OTHER, 60)) {
                sendHit('KNOCKBACK', 15); // 1.5x knockback
            }
        }

        // SNOWBALL
        if (ME.item === 'SNOWBALL') {
            // Spawn projectile
            projectiles.push({
                x: ME.x + 20, y: ME.y + 10,
                vx: ME.facingRight ? 12 : -12,
                vy: -2,
                owner: 'ME',
                type: 'snowball'
            });
            ME.item = 'Nothing'; // Consumed
            updateItemDisplay();
            
            // Send projectile spawn to other player (visual sync)
            if (conn) conn.send({ type: 'SPAWN_PROJ', x: ME.x, y: ME.y, dir: ME.facingRight ? 1 : -1 });
        }

        // NUKE
        if (ME.item === 'NUKE') {
            sendHit('NUKE', 100);
            ME.item = 'Nothing';
            updateItemDisplay();
        }

        // TELEPORTER
        if (ME.item === 'TELEPORTER') {
            sendHit('TELEPORT', 0);
            ME.item = 'Nothing';
            updateItemDisplay();
        }

        // LASER
        if (ME.item === 'LASER') {
            // Infinite range hit
            // Check if facing correct direction
            let hit = false;
            if (ME.facingRight && OTHER.x > ME.x) hit = true;
            if (!ME.facingRight && OTHER.x < ME.x) hit = true;
            
            if (hit) {
                // Visual Laser
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(ME.x + 20, ME.y + 20);
                ctx.lineTo(ME.facingRight ? 1000 : 0, ME.y + 20);
                ctx.stroke();
                sendHit('KNOCKBACK', 50); // Massive hit
            }
            ME.item = 'Nothing';
            updateItemDisplay();
        }
    }

    function checkHit(attacker, defender, range) {
        const dx = Math.abs((attacker.x + attacker.w/2) - (defender.x + defender.w/2));
        const dy = Math.abs((attacker.y + attacker.h/2) - (defender.y + defender.h/2));
        return (dx < range && dy < 50);
    }

    function sendHit(effectType, force) {
        if (conn) {
            conn.send({ type: 'HIT', effect: effectType, force: force, dir: ME.facingRight ? 1 : -1 });
        } else {
            // Single player testing
            applyHitTo(OTHER, effectType, force, ME.facingRight ? 1 : -1);
        }
    }

    // --- RECEIVE HIT LOGIC (Runs when YOU get hit) ---
    function applyHitTo(target, effect, force, dir) {
        if (effect === 'KNOCKBACK') {
            target.vx = dir * force;
            target.vy = -5; // Small pop up
        }
        if (effect === 'FREEZE') {
            target.vx = dir * force;
            target.frozen = true;
            target.color = '#00ffff'; // Turn blue
            setTimeout(() => {
                target.frozen = false;
                target.color = isHost ? '#ff4444' : '#fff'; // Revert color
            }, 500); // 0.5s freeze
        }
        if (effect === 'NUKE') {
            target.vx = 50; // Fly away
            target.vy = -50;
        }
        if (effect === 'TELEPORT') {
            target.x = -100; // Teleport off map
            target.y = -100;
        }
    }

    // --- UI HELPERS ---
    function updateItemDisplay() {
        document.getElementById('item-display').innerText = ME.item;
        
        // Color coding rarities
        const disp = document.getElementById('item-display');
        if (['NUKE','TELEPORTER','LASER'].includes(ME.item)) disp.style.color = '#ff00ff'; // Purple for rare
        else if (ME.item === 'NOTHING') disp.style.color = '#555';
        else disp.style.color = '#fff';
    }

    function updateScore() {
        document.getElementById('score-me').innerText = scores.me;
        document.getElementById('score-enemy').innerText = scores.enemy;
    }

    function spinRNG() {
        if (ME.frozen) return;
        const display = document.getElementById('item-display');
        let i = 0;
        const interval = setInterval(() => {
            display.innerText = ['...','?','...'][i%3];
            i++;
            if (i > 5) {
                clearInterval(interval);
                ME.item = getRandomItem();
                updateItemDisplay();
            }
        }, 100);
    }

    // --- MENUS ---
    function showMenu(id) {
        document.querySelectorAll('.menu-screen').forEach(el => el.style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }
    function generateId() { return Math.random().toString(36).substr(2, 4).toUpperCase(); }

    function setupHost() {
        showMenu('host-menu');
        myId = generateId();
        document.getElementById('host-code').innerText = myId;
        peer = new Peer(myId);
        peer.on('connection', (c) => {
            conn = c;
            initConnection();
            startGame();
        });
        isHost = true;
    }

    function joinGame() {
        const code = document.getElementById('join-code').value.toUpperCase();
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(code);
            conn.on('open', () => {
                initConnection();
                startGame();
            });
        });
        isHost = false;
    }

    function initConnection() {
        conn.on('data', (data) => {
            // Position Sync
            if (data.x !== undefined) {
                OTHER.x = data.x; OTHER.y = data.y; 
                OTHER.item = data.item;
                OTHER.facingRight = data.facingRight;
            }
            // Hit Event
            if (data.type === 'HIT') {
                applyHitTo(ME, data.effect, data.force, data.dir);
            }
            // Projectile Spawn
            if (data.type === 'SPAWN_PROJ') {
                projectiles.push({
                    x: data.x, y: data.y, vx: data.dir * 12, vy: -2, owner: 'OTHER', type: 'snowball'
                });
            }
            // Score Sync
            if (data.type === 'DEATH') {
                scores.me++; // If they died, I get a point
                updateScore();
            }
        });
    }

    function startSingle() { startGame(); }

    function startGame() {
        document.querySelectorAll('.menu-screen').forEach(el => el.style.display = 'none');
        document.getElementById('ui-layer').style.display = 'block';
        ME.x = isHost ? 100 : 800;
        isGameRunning = true;
        gameLoop();
        setInterval(sendData, 20);
    }

    function sendData() {
        if (conn && conn.open) {
            conn.send({ x: ME.x, y: ME.y, item: ME.item, facingRight: ME.facingRight });
        }
    }

    // --- CONTROLS ---
    const keys = {};
    window.addEventListener('keydown', e => {
        keys[e.key.toLowerCase()] = true;
        if (e.key === ' ' && ME.item !== 'Nothing') useItem(); // Space to use Item
        if (e.key === 'e') spinRNG();
        if (e.key.toLowerCase() === 'shift') tryRoll();
    });
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    function tryRoll() {
        if (canRoll && !ME.frozen) {
            ME.rolling = true;
            ME.vx = ME.facingRight ? 15 : -15; // Speed boost
            canRoll = false;
            
            // Cooldown UI
            const msg = document.getElementById('cooldown-msg');
            msg.style.opacity = 1;

            setTimeout(() => ME.rolling = false, 300); // 0.3s duration
            setTimeout(() => {
                canRoll = true;
                msg.style.opacity = 0;
            }, ROLL_COOLDOWN);
        }
    }

    // --- GAME LOOP ---
    function update() {
        if (ME.frozen) return; // Can't move if frozen

        // MOVEMENT
        let speed = SPEED;
        if (ME.item === 'STICK') speed = SPEED * 0.9; // Holding heavy stick?
        
        if (keys['a']) { ME.vx = -speed; ME.facingRight = false; }
        else if (keys['d']) { ME.vx = speed; ME.facingRight = true; }
        else if (!ME.rolling) { ME.vx *= 0.8; } // Friction

        // JUMP (No bouncing - crisp landing)
        if (keys['w'] && ME.y + ME.h >= GROUND) {
            ME.vy = JUMP_FORCE;
        }

        // PHYSICS
        ME.vy += GRAVITY;
        ME.x += ME.vx;
        ME.y += ME.vy;

        // GROUND COLLISION (Crisp stop)
        if (ME.y + ME.h > GROUND) {
            ME.y = GROUND - ME.h;
            ME.vy = 0; // Set strictly to 0 to prevent bounce
        }

        // BOUNDARIES & DEATH
        if (ME.x < -100 || ME.x > canvas.width + 100 || ME.y < -100) {
            // Respawn
            ME.x = 400; ME.y = 0; ME.vx = 0; ME.vy = 0;
            ME.frozen = false;
            scores.enemy++; // Other player gets point
            updateScore();
            if (conn) conn.send({ type: 'DEATH' });
        }

        // PROJECTILES
        for (let i = projectiles.length - 1; i >= 0; i--) {
            let p = projectiles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.2; // Gravity for snowball

            // Hit detection (Snowball vs Player)
            let target = (p.owner === 'ME') ? OTHER : ME;
            
            if (target.x < p.x + 10 && target.x + target.w > p.x &&
                target.y < p.y + 10 && target.y + target.h > p.y) {
                
                // If *I* got hit by *OTHER'S* snowball
                if (p.owner === 'OTHER') {
                    applyHitTo(ME, 'FREEZE', 10, (p.vx > 0 ? 1 : -1));
                }
                projectiles.splice(i, 1);
                continue;
            }

            // Remove if off screen or hits ground
            if (p.y > GROUND || p.x < 0 || p.x > 1000) {
                projectiles.splice(i, 1);
            }
        }
    }

    function draw() {
        // Background
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Floor
        ctx.fillStyle = '#000';
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.fillRect(0, GROUND, canvas.width, 100);
        ctx.beginPath(); ctx.moveTo(0, GROUND); ctx.lineTo(1000, GROUND); ctx.stroke();

        // Projectiles
        ctx.fillStyle = '#fff';
        projectiles.forEach(p => {
            if (sprites.snowball) {
                ctx.drawImage(sprites.snowball, p.x, p.y, 20, 20);
            } else {
                ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
            }
        });

        // Draw Player (ME)
        drawPlayer(ME, ASSETS.player.color, sprites.player);

        // Draw Player (OTHER)
        drawPlayer(OTHER, ASSETS.enemy.color, sprites.enemy);
    }

    function drawPlayer(p, defaultColor, sprite) {
        if (sprite) {
            ctx.drawImage(sprite, p.x, p.y, p.w, p.h);
        } else {
            ctx.fillStyle = defaultColor;
            ctx.fillRect(p.x, p.y, p.w, p.h);
        }
        
        // Draw Item Held
        if (p.item !== 'NOTHING') {
            ctx.fillStyle = '#fff';
            ctx.font = '10px Arial';
            ctx.fillText(p.item, p.x, p.y - 10);
        }
        
        // Frozen status
        if (p.frozen) {
            ctx.strokeStyle = '#00ffff';
            ctx.strokeRect(p.x-5, p.y-5, p.w+10, p.h+10);
        }
    }

    function gameLoop() {
        if (!isGameRunning) return;
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

</script>
</body>
</html>
