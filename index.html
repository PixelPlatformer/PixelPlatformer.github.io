<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platformer</title>
    <link id="favicon" rel="icon" type="image/x-icon" href="">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tiny5&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #080808; color: #fff; font-family: 'Tiny5', sans-serif; overflow: hidden; cursor: crosshair; }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        canvas#gameCanvas { display: none; background: #12121e; width: 100vw; height: 100vh; image-rendering: pixelated; }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .neon-glow { color: #fff; text-shadow: 0 0 10px #fff, 0 0 20px #00d2ff; }
        .menu-screen { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 100; min-width: 400px; background: rgba(10,10,15,0.98); padding: 40px; border: 2px solid #fff; box-shadow: 0 0 30px rgba(255,255,255,0.1); }
        #main-menu { display: block; }
        .btn { background: #000; color: #fff; border: 2px solid #fff; padding: 12px 20px; font-family: 'Tiny5'; font-size: 22px; cursor: pointer; margin: 10px 0; text-transform: uppercase; width: 100%; transition: 0.2s; }
        .btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }

        #warmup-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; color: #fff; text-shadow: 0 0 30px #00d2ff; z-index: 150; display: none; pointer-events: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 20; }
        #match-info { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); font-size: 28px; }
        #inv-slot { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90px; height: 90px; background: rgba(0,0,0,0.8); border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 14px; pointer-events: auto; }
        #admin-panel { position: absolute; top: 80px; left: 20px; background: rgba(0,0,0,0.95); border: 2px solid red; padding: 15px; pointer-events: auto; display: none; z-index: 30; width: 180px;}
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div><h1 class="neon-glow">LOADING WORLD</h1></div>
    <div id="version-tag" style="position:fixed; bottom:10px; left:10px; font-size:14px; color:rgba(255,255,255,0.3);">v1.21.0</div>
    <canvas id="bg-canvas"></canvas>
    
    <div id="main-menu" class="menu-screen">
        <h1 class="neon-glow" style="font-size: 55px; margin-bottom: 25px;">ARENA ROYALE</h1>
        <input type="text" id="player-name-input" placeholder="DISPLAY NAME" maxlength="12" style="background:#000; color:#fff; border:1px solid #fff; font-family:'Tiny5'; font-size:20px; padding:10px; width:100%; text-align:center; margin-bottom:10px;">
        <button class="btn" onclick="setupHost()">HOST SERVER</button>
        <button class="btn" onclick="showMenu('join-menu')">JOIN SERVER</button>
    </div>

    <div id="join-menu" class="menu-screen">
        <h2 class="neon-glow">CONNECTION</h2>
        <input type="text" id="join-code-input" placeholder="4-LETTER KEY" style="background:#000; color:#fff; border:1px solid #fff; font-family:'Tiny5'; font-size:20px; padding:10px; width:100%; text-align:center; margin-bottom:10px;">
        <button class="btn" onclick="joinGame()">LINK START</button>
        <button class="btn" onclick="showMenu('main-menu')">CANCEL</button>
    </div>

    <div id="host-lobby" class="menu-screen">
        <h2 class="neon-glow">LOBBY: <span id="host-code-display" style="color: #ff4500;">...</span></h2>
        <div id="player-list" style="margin: 20px 0; text-align:left; color:#fff;"></div>
        <button class="btn" onclick="triggerStart()" id="start-btn" disabled style="opacity:0.3;">ENTER ARENA</button>
        <button class="btn" onclick="location.reload()">ABANDON</button>
    </div>

    <div id="warmup-overlay">3</div>

    <div id="ui-layer">
        <div id="match-info">ROUND <span id="round-num">1</span>/5</div>
        <div id="admin-panel">
            <button class="btn" style="font-size:14px;" onclick="cheatFly = !cheatFly">FLY</button>
            <button class="btn" style="font-size:14px;" onclick="cheatLuck = !cheatLuck">GOD LUCK</button>
        </div>
        <div id="inv-slot">EMPTY</div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const bgCanvas = document.getElementById('bg-canvas');
    const bgCtx = bgCanvas.getContext('2d');

    // --- GLOBAL STATE ---
    const PLATFORMS = [];
    const MAGMA_Y = 800;
    const GRAVITY = 0.55, JUMP = -13, MOVE_SPD = 2.4;
    let isGameRunning = false, isHost = false, connections = {}, peer, myId;
    let mouseX = 0, mouseY = 0, myAngle = 0, warmupTime = 0, players = {}, currentRound = 1, isDead = false;
    let cheatFly = false, cheatLuck = false;

    const ME = { x: 0, y: -100, r: 22, vx: 0, vy: 0, rot: 0, name: 'ME', color: '#fff', swing: 0, grounded: false };

    // --- INITIALIZE WORLD ---
    function buildMap() {
        PLATFORMS.length = 0;
        for(let i=0; i<20; i++) {
            PLATFORMS.push({ x: -800 + (i * 140), y: 500, w: 130, h: 60, contactTime: 0, falling: false, vy: 0 });
        }
    }
    buildMap(); // Run immediately

    window.onload = () => { document.getElementById('loading-overlay').style.display='none'; };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; bgCanvas.width = window.innerWidth; bgCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    // --- MULTIPLAYER ---
    function setupHost() {
        ME.name = document.getElementById('player-name-input').value || "HOST";
        ME.color = `hsl(${Math.random() * 360}, 75%, 65%)`;
        myId = Math.random().toString(36).substr(2, 4).toUpperCase();
        document.getElementById('host-code-display').innerText = myId;
        showMenu('host-lobby');
        peer = new Peer(myId);
        peer.on('connection', c => {
            c.on('data', data => {
                if (data.type === 'JOIN') {
                    connections[c.peer] = c; players[c.peer] = { name: data.name, color: data.color, x: 0, y: 0, dead: false };
                    document.getElementById('player-list').innerHTML += `<p>${data.name} Joined!</p>`;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('start-btn').style.opacity = "1";
                }
                if (data.type === 'UPDATE') players[data.id] = data.state;
            });
        });
        isHost = true;
    }

    function joinGame() {
        ME.name = document.getElementById('player-name-input').value || "GUEST";
        ME.color = `hsl(${Math.random() * 360}, 75%, 65%)`;
        const code = document.getElementById('join-code-input').value.toUpperCase();
        peer = new Peer();
        peer.on('open', () => {
            const c = peer.connect(code);
            c.on('open', () => { c.send({ type: 'JOIN', name: ME.name, color: ME.color }); showMenu('host-lobby'); });
            c.on('data', data => {
                if (data.type === 'START') startGame();
                if (data.type === 'UPDATE') players[data.id] = data.state;
            });
        });
    }

    function triggerStart() { for(let id in connections) connections[id].send({type:'START'}); startGame(); }

    function startGame() {
        document.querySelectorAll('.menu-screen').forEach(e => e.style.display = 'none');
        document.getElementById('ui-layer').style.display = 'block'; 
        canvas.style.display = 'block';
        isGameRunning = true;
        ME.x = isHost ? 0 : 500; ME.y = -50; ME.vx = 0; ME.vy = 0; // Force spawn above bridge
        warmupTime = 180;
        requestAnimationFrame(gameLoop);
        setInterval(() => {
            if(!peer) return;
            const state = { x: ME.x, y: ME.y, rot: ME.rot, name: ME.name, color: ME.color, dead: isDead };
            for(let id in connections) connections[id].send({ type: 'UPDATE', id: peer.id, state });
        }, 30);
    }

    window.addEventListener('keydown', e => {
        if(e.key === '/') { const p = prompt("PIN:"); if(p === '67412') document.getElementById('admin-panel').style.display='block'; return; }
        if(isDead || warmupTime > 0) return;
        keys[e.key.toLowerCase()] = true;
    });
    const keys = {};
    window.onkeyup = e => keys[e.key.toLowerCase()] = false;

    function update() {
        if (!isGameRunning) return;
        if (warmupTime > 0) {
            warmupTime--;
            const ov = document.getElementById('warmup-overlay'); 
            ov.style.display = 'block'; ov.innerText = Math.ceil(warmupTime/60);
            if(warmupTime === 0) { ov.innerText = "GO!"; setTimeout(()=>ov.style.display='none', 500); }
            return;
        }

        if(!isDead) {
            if (cheatFly) {
                if (keys['w']) ME.y -= 7; if (keys['s']) ME.y += 7;
                if (keys['a']) ME.x -= 7; if (keys['d']) ME.x += 7;
            } else {
                if (keys['a']) { ME.vx = -MOVE_SPD; ME.rot -= 0.1; } else if (keys['d']) { ME.vx = MOVE_SPD; ME.rot += 0.1; } else { ME.vx *= 0.88; }
                ME.vy += GRAVITY; ME.x += ME.vx; ME.y += ME.vy;
                ME.grounded = false;
                PLATFORMS.forEach(p => {
                    if (ME.vy >= 0 && ME.y + ME.r > p.y && ME.y + ME.r < p.y + 40 && ME.x > p.x && ME.x < p.x + p.w) {
                        ME.y = p.y - ME.r; ME.vy = 0; ME.grounded = true;
                        p.contactTime++; if(p.contactTime > 300) p.falling = true;
                    }
                    if(p.falling) { p.vy += 0.2; p.y += p.vy; }
                });
                if(keys['w'] && ME.grounded) ME.vy = JUMP;
            }
            if (ME.y > MAGMA_Y) isDead = true;
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        bgCtx.fillStyle = "#0a0a0a"; bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
        
        // Draw World
        PLATFORMS.forEach(p => {
            ctx.fillStyle = "#3e2723"; ctx.fillRect(p.x, p.y+20, p.w, 40);
            ctx.fillStyle = "#4caf50"; ctx.fillRect(p.x, p.y, p.w, 20);
        });
        ctx.fillStyle = "#ff4500"; ctx.fillRect(0, MAGMA_Y, canvas.width, 400);

        // Forced Draw Player
        if(!isDead) {
            ctx.save(); ctx.translate(ME.x, ME.y);
            ctx.strokeStyle = "#000"; ctx.lineWidth = 5; ctx.beginPath(); ctx.arc(0, 0, ME.r, 0, 6.3); ctx.stroke();
            ctx.rotate(ME.rot); ctx.fillStyle = ME.color; ctx.beginPath(); ctx.arc(0, 0, ME.r, 0, 6.3); ctx.fill();
            ctx.restore();
        }

        for (let id in players) {
            const p = players[id];
            if(!p.dead) {
                ctx.save(); ctx.translate(p.x, p.y);
                ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(0, 0, 22, 0, 6.3); ctx.fill();
                ctx.restore();
            }
        }
    }

    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    function showMenu(id) { document.querySelectorAll('.menu-screen').forEach(e => e.style.display = 'none'); document.getElementById(id).style.display = 'block'; }
</script>
</body>
</html>
